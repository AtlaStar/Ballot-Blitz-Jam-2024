[gd_resource type="Resource" script_class="DialogicStyle" load_steps=12 format=3 uid="uid://bc3dxtyhadc2e"]

[ext_resource type="Script" path="res://addons/dialogic/Resources/dialogic_style_layer.gd" id="2_n07c1"]
[ext_resource type="Script" path="res://addons/dialogic/Modules/DefaultLayoutParts/Layer_Input/full_advance_input_layer.gd" id="2_rgp4a"]
[ext_resource type="PackedScene" uid="uid://cn674foxwedqu" path="res://addons/dialogic/Modules/DefaultLayoutParts/Layer_Input/full_advance_input_layer.tscn" id="3_5o1yk"]
[ext_resource type="PackedScene" uid="uid://d2it0xiap3gnt" path="res://addons/dialogic/Modules/DefaultLayoutParts/Layer_Textbubble/text_bubble_layer.tscn" id="4_idfjy"]
[ext_resource type="Script" path="res://addons/dialogic/Modules/DefaultLayoutParts/Layer_Textbubble/text_bubble_layer.gd" id="4_mgpjy"]
[ext_resource type="Script" path="res://addons/dialogic/Resources/dialogic_style.gd" id="5_gsq6r"]

[sub_resource type="GDScript" id="GDScript_dsdow"]
script/source = "@tool
extends DialogicLayoutBase

## This layout won't do anything on its own

var bubbles: Array = []
var registered_characters: Dictionary = {}

@export_group(\"Main\")
@export_range(1, 25, 1) var bubble_count: int = 2


func _ready() -> void:
	if Engine.is_editor_hint():
		return

	DialogicUtil.autoload().Text.about_to_show_text.connect(_on_dialogic_text_event)
	$Example/CRT.position = $Example.get_viewport_rect().size/2

	if not has_node('TextBubbleLayer'):
		return

	if len(bubbles) < bubble_count:
		add_bubble()


func register_character(character:Variant, node:Node):
	if typeof(character) == TYPE_STRING:
		var character_string: String = character
		if character.begins_with(\"res://\"):
			character = load(character)
		else:
			character = DialogicResourceUtil.get_character_resource(character)
		if not character:
			printerr(\"[Dialogic] Textbubble: Tried registering character from invalid string '\", character_string, \"'.\")

	registered_characters[character] = node
	if len(registered_characters) > len(bubbles) and len(bubbles) < bubble_count:
		add_bubble()


func _get_persistent_info() -> Dictionary:
	return {\"textbubble_registers\": registered_characters}


func _load_persistent_info(info: Dictionary) -> void:
	var register_info: Dictionary = info.get(\"textbubble_registers\", {})
	for character in register_info:
		if is_instance_valid(register_info[character]):
			register_character(character, register_info[character])


func add_bubble() -> void:
	if not has_node('TextBubbleLayer'):
		return

	var new_bubble: Control = get_node(\"TextBubbleLayer\").add_bubble()
	bubbles.append(new_bubble)


func _on_dialogic_text_event(info:Dictionary):
	var bubble_to_use: Node
	for bubble in bubbles:
		if bubble.current_character == info.character:
			bubble_to_use = bubble

	if bubble_to_use == null:
		for bubble in bubbles:
			if bubble.current_character == null:
				bubble_to_use = bubble

	if bubble_to_use == null:
		bubble_to_use = bubbles[0]

	var node_to_point_at: Node
	if info.character in registered_characters:
		node_to_point_at = registered_characters[info.character]
		$Example.hide()
	else:
		node_to_point_at = $Example/CRT/Marker
		$Example.show()

	bubble_to_use.current_character = info.character
	bubble_to_use.node_to_point_at = node_to_point_at
	bubble_to_use.reset()
	if has_node('TextBubbleLayer'):
		get_node(\"TextBubbleLayer\").bubble_apply_overrides(bubble_to_use)
	bubble_to_use.open()

	## Now close other bubbles
	for bubble in bubbles:
		if bubble != bubble_to_use:
			bubble.close()
			bubble.current_character = null
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_70ljh"]
content_margin_left = 5.0
content_margin_top = 5.0
content_margin_right = 5.0
content_margin_bottom = 5.0
bg_color = Color(0, 0, 0, 0.654902)

[sub_resource type="PackedScene" id="PackedScene_f3kbg"]
_bundled = {
"conn_count": 0,
"conns": PackedInt32Array(),
"editable_instances": [],
"names": PackedStringArray("Custom", "CanvasLayer", "script", "Example", "Control", "visible", "layout_mode", "anchors_preset", "anchor_right", "anchor_bottom", "grow_horizontal", "grow_vertical", "Label", "RichTextLabel", "layout_mode", "anchors_preset", "anchor_top", "anchor_bottom", "offset_left", "offset_top", "offset_right", "offset_bottom", "grow_vertical", "theme_override_styles/normal", "bbcode_enabled", "text", "CRT", "ColorRect", "layout_mode", "offset_left", "offset_top", "offset_right", "offset_bottom", "rotation", "color", "Marker", "Marker2D", "position", "FullAdvanceInputLayer", "Control", "layout_mode", "anchors_preset", "anchor_right", "anchor_bottom", "grow_horizontal", "grow_vertical", "mouse_filter", "script", "apply_overrides_on_ready", "TextBubbleLayer", "Control", "layout_mode", "anchors_preset", "mouse_filter", "script", "choices_text_size", "apply_overrides_on_ready"),
"node_count": 7,
"node_paths": [NodePath("."), NodePath("./Example"), NodePath("./Example"), NodePath("./Example/CRT"), NodePath("."), NodePath(".")],
"nodes": PackedInt32Array(-1, -1, 1, 0, -1, 1, 2, 0, 0, 1073741824, 0, 4, 3, -1, 7, 5, 1, 6, 2, 7, 3, 8, 4, 9, 5, 10, 6, 11, 7, 0, 1073741825, 0, 13, 12, -1, 12, 14, 8, 15, 9, 16, 10, 17, 11, 18, 12, 19, 13, 20, 14, 21, 15, 22, 16, 23, 17, 24, 18, 25, 19, 0, 1073741826, 0, 27, 26, -1, 7, 28, 20, 29, 21, 30, 22, 31, 23, 32, 24, 33, 25, 34, 26, 0, 1073741827, 0, 36, 35, -1, 1, 37, 27, 0, 1073741828, 0, 39, 38, 28, 9, 40, 29, 41, 30, 42, 31, 43, 32, 44, 33, 45, 34, 46, 35, 47, 36, 48, 37, 0, 1073741829, 0, 50, 49, 38, 6, 51, 39, 52, 40, 53, 41, 54, 42, 55, 43, 56, 44, 0),
"variants": [SubResource("GDScript_dsdow"), false, 3, 15, 1.0, 1.0, 2, 2, 1, 2, 1.0, 1.0, 12.0, -235.0, 835.0, -14.0, 0, SubResource("StyleBoxFlat_70ljh"), true, "This is a fallback bubble, that is not actually connected to any character. In game use the following code to add speech bubbles to a character:
[color=darkgray]
var layout = Dialogic.start(timeline_path)
layout.register_character(character_resource, node)
[/color]
- [color=lightblue]character_resource[/color] should be a loaded DialogicCharacter (a .dch file).
- [color=lightblue]node[/color] should be the 2D or 3D node the bubble should point at.
	-> E.g. [color=darkgray]layout.register_character(load(\"res://path/to/my/character.dch\"), $BubbleMarker)", 0, 504.0, 290.0, 540.0, 324.0, 0.785397, Color(1, 0.313726, 1, 1), Vector2(10.6066, 9.1924), ExtResource("3_5o1yk"), 3, 15, 1.0, 1.0, 2, 2, 2, ExtResource("2_rgp4a"), true, ExtResource("4_idfjy"), 3, 0, 2, ExtResource("4_mgpjy"), 9, true],
"version": 3
}

[sub_resource type="Resource" id="Resource_o8px3"]
script = ExtResource("2_n07c1")
scene = ExtResource("3_5o1yk")
overrides = {}

[sub_resource type="Resource" id="Resource_q3q1f"]
script = ExtResource("2_n07c1")
scene = ExtResource("4_idfjy")
overrides = {}

[resource]
script = ExtResource("5_gsq6r")
name = "textbubble"
base_scene = SubResource("PackedScene_f3kbg")
base_overrides = {}
layers = Array[ExtResource("2_n07c1")]([SubResource("Resource_o8px3"), SubResource("Resource_q3q1f")])
metadata/_latest_layer = -1
